<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0b1016">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Space Trader - Dev Testing Interface</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0b1016;
            --panel: #0f1724;
            --panel-border: rgba(45, 212, 191, 0.3);
            --text: #e2e8f0;
            --muted: #93a4b7;
            --accent: #2dd4bf;
            --accent-strong: #10b981;
            --danger: #f87171;
            --info: #60a5fa;
            --hover: rgba(45, 212, 191, 0.1);
        }
        html, body { background: var(--bg); }
        body {
            font-family: "Space Mono", "IBM Plex Mono", "JetBrains Mono", "Menlo", "Consolas", monospace;
            padding: calc(20px + env(safe-area-inset-top)) 20px calc(20px + env(safe-area-inset-bottom));
            background: radial-gradient(circle at top, rgba(45, 212, 191, 0.08), transparent 45%),
                        radial-gradient(circle at 20% 20%, rgba(96, 165, 250, 0.12), transparent 35%),
                        linear-gradient(135deg, #0b1016 0%, #0f1724 50%, #0b1016 100%);
            background-color: #0b1016;
            color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: var(--panel);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
        }
        h1 { color: var(--accent); margin-bottom: 10px; font-size: 24px; }
        .server-info { color: var(--accent-strong); font-size: 14px; }
        
        .section {
            background: var(--panel);
            margin-bottom: 15px;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .section-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 36, 0.5);
            transition: background 0.2s;
        }
        .section-header:hover {
            background: var(--hover);
        }
        .section-header h2 {
            margin: 0;
            color: var(--accent-strong);
            font-size: 18px;
            border: none;
            padding: 0;
        }
        .section-toggle {
            color: var(--muted);
            font-size: 20px;
            transition: transform 0.2s;
        }
        .section.expanded .section-toggle {
            transform: rotate(90deg);
        }
        .section-content {
            padding: 20px;
            display: none;
        }
        .section.expanded .section-content {
            display: block;
        }
        
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 6px;
            color: var(--muted);
            font-size: 13px;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            background: var(--bg);
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text);
            font-family: inherit;
            border-radius: 4px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        .inline-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        button {
            padding: 10px 18px;
            background: var(--info);
            color: #04121a;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        button:hover {
            background: #7bb6ff;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button.danger {
            background: var(--danger);
            color: #1a1a1a;
        }
        button.danger:hover {
            background: #ff8f8f;
        }
        button.success {
            background: var(--accent-strong);
            color: #04121a;
        }
        button.success:hover {
            background: #12d99f;
        }
        
        .status-box {
            padding: 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
            color: var(--accent-strong);
        }
        
        .results {
            background: var(--panel);
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            max-height: 600px;
            overflow-y: auto;
        }
        .results h2 {
            color: var(--accent-strong);
            margin-bottom: 15px;
            font-size: 18px;
            border: none;
            padding: 0;
        }
        .results pre {
            color: var(--accent-strong);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
            line-height: 1.6;
        }
        .error { color: var(--danger); }
        .success { color: var(--accent-strong); }
        .info { color: var(--info); }
        
        .doc-toggle {
            font-size: 11px;
            color: var(--accent-strong);
            cursor: pointer;
            text-decoration: underline;
            margin-left: 10px;
        }
        .doc-toggle:hover { color: var(--accent); }
        
        .log-container {
            background: #1a1a1a;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .auto-tick-control {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(15, 23, 36, 0.5);
            border-radius: 4px;
            margin: 10px 0;
        }
        .auto-tick-control label {
            margin: 0;
            color: var(--muted);
            font-size: 13px;
        }
        .auto-tick-control button {
            flex: 0 0 auto;
        }
        .auto-tick-status {
            color: var(--accent-strong);
            font-size: 12px;
        }
        
        .description {
            color: var(--muted);
            font-size: 12px;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .endpoint-doc {
            margin: 15px 0;
            padding: 12px;
            background: rgba(8, 15, 24, 0.7);
            border-left: 3px solid var(--info);
            border-radius: 4px;
        }
        .endpoint-header { margin-bottom: 8px; }
        .endpoint-header code { color: var(--accent-strong); font-size: 13px; }
        .endpoint-description { color: var(--text); margin-bottom: 10px; line-height: 1.5; }
        .endpoint-params, .endpoint-body, .endpoint-response, .endpoint-notes {
            margin-top: 8px;
            font-size: 12px;
        }
        .endpoint-params ul, .endpoint-body ul, .endpoint-notes ul {
            margin: 5px 0 0 20px;
            padding: 0;
        }
        .endpoint-params li, .endpoint-body li, .endpoint-notes li {
            margin: 3px 0;
            color: var(--muted);
        }
        .endpoint-params strong, .endpoint-body strong, .endpoint-response strong, .endpoint-notes strong {
            color: var(--info);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Space Trader - Dev Testing Interface</h1>
            <p class="server-info" id="serverInfo">Running on Local Node.js Server</p>
        </div>
        
        <!-- Galaxy Operations -->
        <div class="section expanded">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üåå Galaxy Operations</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Initialize, manage, and monitor the entire galaxy simulation.</div>
                <div class="form-group">
                    <label>Seed (optional):</label>
                    <input type="text" id="galaxySeed" placeholder="test-galaxy-123" value="">
                </div>
                <div class="button-group">
                    <button onclick="initializeGalaxy()">Initialize Galaxy</button>
                    <button onclick="tickGalaxy()">Tick All Systems</button>
                    <button onclick="checkHealth()">Health Check</button>
                    <button onclick="checkHealthAndWriteLog()" class="danger">üìù Check & Write Log</button>
                    <button onclick="resetZeroInventoryMonitoring()" class="success">üîÑ Reset Zero Inventory Monitoring</button>
                    <button onclick="flushState()" class="danger">üíæ Flush to DB</button>
                    <span class="doc-toggle" onclick="toggleSectionDocs('galaxyDocs')">üìñ Show Docs</span>
                </div>
                <div class="auto-tick-control">
                    <label>Auto-Tick:</label>
                    <button onclick="toggleAutoTick()" id="autoTickBtn">Loading...</button>
                    <span class="auto-tick-status" id="autoTickStatus">Checking status...</span>
                </div>
                <div id="galaxyDocs" style="display: none;"></div>
            </div>
        </div>

        <!-- System Operations -->
        <div class="section expanded">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>‚≠ê System Operations</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Inspect and interact with individual star systems.</div>
                <div class="inline-group">
                    <div class="form-group">
                        <label>System ID (0-255):</label>
                        <input type="number" id="systemId" min="0" max="255" value="0">
                    </div>
                    <div class="form-group">
                        <label>Action:</label>
                        <select id="systemAction">
                            <option value="snapshot">Snapshot</option>
                        </select>
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="systemOperation()">Execute</button>
                    <button onclick="compareSystems()">Compare Systems (0-5)</button>
                    <span class="doc-toggle" onclick="toggleSectionDocs('systemDocs')">üìñ Show Docs</span>
                </div>
                <div id="systemDocs" style="display: none;"></div>
            </div>
        </div>

        <!-- Ship Operations -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üõ∏ Ship Operations</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Inspect and control individual ships (NPCs and players).</div>
                <div class="inline-group">
                    <div class="form-group">
                        <label>Ship ID:</label>
                        <input type="text" id="shipId" placeholder="npc-0" value="npc-0">
                    </div>
                    <div class="form-group">
                        <label>Action:</label>
                        <select id="shipAction">
                            <option value="state">Get State</option>
                            <option value="tick">Tick</option>
                        </select>
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="shipOperation()">Execute</button>
                    <button onclick="listShips()">List Ships (npc-0 to npc-9)</button>
                    <span class="doc-toggle" onclick="toggleSectionDocs('shipDocs')">üìñ Show Docs</span>
                </div>
                <div id="shipDocs" style="display: none;"></div>
            </div>
        </div>

        <!-- Navigation Tuning -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üß≠ Navigation Tuning</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Experiment with in-system travel fuel usage for playtesting.</div>
                <div class="inline-group">
                    <div class="form-group">
                        <label>In-system fuel usage</label>
                        <select id="navFuelEnabled">
                            <option value="false">Disabled</option>
                            <option value="true">Enabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fuel per sector (LY)</label>
                        <input type="number" id="navFuelRate" min="0" step="0.01" value="0.02">
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="saveNavigationConfig()">Save Navigation Config</button>
                    <button onclick="loadNavigationConfig()">Refresh</button>
                </div>
                <div class="status-box" id="navConfigStatus">Navigation config ready.</div>
            </div>
        </div>

        <!-- Player Management -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üßë‚ÄçüöÄ Player Management</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Use <strong>player-1</strong> to match the Player UI. Initialize or inspect a player ship here.</div>
                <div class="inline-group">
                    <div class="form-group">
                        <label>Player ID:</label>
                        <input type="text" id="playerId" placeholder="player-1" value="player-1">
                    </div>
                    <div class="form-group">
                        <label>Player Name:</label>
                        <input type="text" id="playerName" placeholder="Player Ship" value="Player Ship">
                    </div>
                </div>
                <div class="inline-group">
                    <div class="form-group">
                        <label>System ID:</label>
                        <input type="number" id="playerSystemId" min="0" max="255" value="0">
                    </div>
                    <div class="form-group">
                        <label>Seed (optional):</label>
                        <input type="text" id="playerSeed" placeholder="player-seed-123" value="">
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="initializePlayerShip()">Initialize Player</button>
                    <button onclick="loadPlayerState()">Get Player State</button>
                    <button onclick="listPlayers()">List Players (player-1..player-9)</button>
                    <button onclick="openPlayerUI()" class="success">Open Player UI</button>
                    <button onclick="loadPlayerLogs()">View Player Logs</button>
                    <button onclick="clearPlayerLogs()" class="danger">Clear Player Logs</button>
                </div>
                <div class="status-box" id="playerManagementStatus">Ready. Initialize a player to start testing.</div>
            </div>
        </div>

        <!-- Quick Tests -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üìä Quick Tests</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Run automated test suites and analysis tools.</div>
                <div class="button-group">
                    <button onclick="quickTest()">Run Quick Test Suite</button>
                    <button onclick="priceComparison()">Compare Prices (Systems 0-9)</button>
                    <button onclick="marketAnalysis()">Market Analysis (System 0)</button>
                </div>
            </div>
        </div>

        <!-- System Monitor -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üì° System Monitor</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Real-time monitoring interface with live trading data, price charts, and ship status.</div>
                <div class="button-group">
                    <button onclick="window.open('/monitor', '_blank')" class="success">Open System Monitor</button>
                </div>
            </div>
        </div>

        <!-- Logging Switches -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üß∞ Logging Switches</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Toggle log capture for core systems. These switches persist in logging-config.json.</div>
                <div class="inline-group">
                    <div class="form-group">
                        <label>Global Logging</label>
                        <button onclick="toggleGlobalLogging()" id="globalLoggingBtn">Loading...</button>
                        <div class="status-box" id="globalLoggingStatus">Loading...</div>
                    </div>
                    <div class="form-group">
                        <label>Trade Log Capture</label>
                        <button onclick="toggleTradeLoggingEnabled()" id="tradeLoggingEnabledBtn">Loading...</button>
                        <div class="status-box" id="tradeLoggingEnabledStatus">Loading...</div>
                    </div>
                    <div class="form-group">
                        <label>Player Log Capture</label>
                        <button onclick="togglePlayerLoggingEnabled()" id="playerLoggingEnabledBtn">Loading...</button>
                        <div class="status-box" id="playerLoggingEnabledStatus">Loading...</div>
                    </div>
                    <div class="form-group">
                        <label>Expectation Shortfall File Log</label>
                        <div class="inline-group">
                            <button onclick="toggleExpectationShortfallLoggingEnabled()" id="shortfallLoggingEnabledBtn">Loading...</button>
                            <input type="number" id="shortfallThresholdInput" min="0" step="1000" value="10000">
                            <button onclick="updateExpectationShortfallThreshold()">Set Threshold</button>
                        </div>
                        <div class="status-box" id="shortfallLoggingEnabledStatus">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Logging -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üîä Trade Logging</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Configure which traders' activities are logged to the console.</div>
                <div class="form-group">
                    <label>Logging Mode:</label>
                    <select id="tradeLoggingMode" onchange="updateTradeLogging()">
                        <option value="all">All Traders</option>
                        <option value="none" selected>None (Hide All)</option>
                        <option value="custom">Specific Trader...</option>
                    </select>
                </div>
                <div class="form-group" id="customShipIdGroup" style="display: none;">
                    <label>Ship ID:</label>
                    <div class="inline-group">
                        <input type="text" id="customShipId" placeholder="npc-123" value="">
                        <button onclick="setCustomTradeLogging()">Set</button>
                    </div>
                </div>
                <div class="status-box" id="tradeLoggingStatus">Loading...</div>
            </div>
        </div>

        <!-- Trade Logs -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üìã Trade Logs</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">View recent trade activity from logged traders.</div>
                <div class="button-group">
                    <button onclick="loadTradeLogs()">Refresh Logs</button>
                    <button onclick="clearTradeLogs()" class="danger">Clear Logs</button>
                    <button onclick="toggleAutoRefreshLogs()" id="autoRefreshLogsBtn">Auto-Refresh: OFF</button>
                </div>
                <div class="log-container" id="tradeLogsContainer">
                    <div style="color: #aaa;">Click "Refresh Logs" to load trade activity</div>
                </div>
            </div>
        </div>

        <!-- Decision Monitor -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üéØ Decision Monitor</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Monitor all decisions and choices made by a specific NPC trader. Enable decision logging for an NPC to see detailed decision-making process.</div>
                <div class="form-group">
                    <label>NPC Ship ID:</label>
                    <div class="inline-group">
                        <input type="text" id="decisionMonitorShipId" placeholder="npc-447" value="">
                        <button onclick="enableDecisionMonitoring()">Enable Monitoring</button>
                        <button onclick="disableDecisionMonitoring()" class="danger">Disable</button>
                    </div>
                </div>
                <div class="status-box" id="decisionMonitorStatus">Not monitoring any NPC</div>
                <div class="button-group">
                    <button onclick="loadDecisionLogs()">Refresh Decision Logs</button>
                    <button onclick="clearDecisionLogs()" class="danger">Clear Decision Logs</button>
                    <button onclick="toggleAutoRefreshDecisionLogs()" id="autoRefreshDecisionLogsBtn">Auto-Refresh: OFF</button>
                </div>
                <div class="log-container" id="decisionLogsContainer">
                    <div style="color: #aaa;">Enter an NPC ID and click "Enable Monitoring" to start</div>
                </div>
            </div>
        </div>

        <!-- Economic Monitoring -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üìä Economic Monitoring & Analysis</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Monitor economic health, wealth distribution, and price volatility. Collect data over time and get recommendations for balance improvements.</div>
                <div class="button-group">
                    <button onclick="collectMonitoringData()">Collect Data Now</button>
                    <button onclick="viewMonitoringData()">View Collected Data</button>
                    <button onclick="analyzeMonitoring()">Analyze & Get Recommendations</button>
                    <button onclick="clearMonitoringData()" class="danger">Clear Monitoring Data</button>
                </div>
                <div class="status-box" id="monitoringStatus">Ready. Data is collected automatically on each galaxy tick.</div>
                <div id="monitoringResults" style="display: none; margin-top: 15px;">
                    <div class="log-container">
                        <pre id="monitoringResultsContent" style="color: #6bcf7f; white-space: pre-wrap; word-wrap: break-word; font-size: 12px;"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Galactic Health -->
        <div class="section">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>üè• Galactic Health Management</h2>
                <span class="section-toggle">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="description">Monitor galactic health metrics including ship spawns vs removals, trade quality, and population health.</div>
                <div class="button-group">
                    <button onclick="getGalacticHealth()">Get Galactic Health</button>
                    <a href="leaderboard.html" style="color: #4a9eff; text-decoration: underline; padding: 10px 18px; display: inline-block;">üìä View Leaderboard</a>
                    <a href="markets.html" style="color: #4a9eff; text-decoration: underline; padding: 10px 18px; display: inline-block;">üìà Galactic Markets</a>
                </div>
                <div class="status-box" id="galacticHealthStatus">Ready. Click "Get Galactic Health" to view metrics.</div>
                <div id="galacticHealthResults" style="display: none; margin-top: 15px;">
                    <div class="log-container">
                        <pre id="galacticHealthResultsContent" style="color: #6bcf7f; white-space: pre-wrap; word-wrap: break-word; font-size: 12px;"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="results">
            <h2>üìã Results</h2>
            <pre id="results">Ready. Click any button to start testing.</pre>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        
        function toggleSection(header) {
            const section = header.closest('.section');
            section.classList.toggle('expanded');
        }
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function apiCall(method, endpoint, body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (response.ok) {
                    log(`${method} ${endpoint} - Success`, 'success');
                    log(JSON.stringify(data, null, 2));
                    return { success: true, data };
                } else {
                    log(`${method} ${endpoint} - Error: ${data.error || response.statusText}`, 'error');
                    log(JSON.stringify(data, null, 2), 'error');
                    return { success: false, data };
                }
            } catch (error) {
                log(`${method} ${endpoint} - Exception: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function initializeGalaxy() {
            clearResults();
            log('Initializing galaxy...', 'info');
            const seed = document.getElementById('galaxySeed').value || `dev-${Date.now()}`;
            await apiCall('POST', '/api/galaxy/initialize', { seed });
        }

        async function tickGalaxy() {
            clearResults();
            log('Ticking all systems...', 'info');
            await apiCall('POST', '/api/galaxy/tick');
        }

        async function checkHealth() {
            clearResults();
            log('Checking health...', 'info');
            await apiCall('GET', '/api/health');
        }

        async function checkHealthAndWriteLog() {
            if (!confirm('Write log and stop logging? This will:\n- Collect snapshots\n- Write cycle log file\n- Stop logging\n\n(Does NOT reset the galaxy)\n\nContinue?')) return;
            try {
                clearResults();
                log('Writing log and stopping logging...', 'info');
                const result = await apiCall('POST', '/api/galaxy/check-and-log');
                if (result.success && result.data) {
                    const data = result.data;
                    if (data.logWritten) {
                        log('‚úì Log written successfully', 'success');
                    }
                    if (data.loggingPaused) {
                        log('‚úì Logging paused. Restart server to resume.', 'info');
                    }
                    log('Check cycle-log.json for details.', 'info');
                } else {
                    log(`Failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`Error writing log: ${error.message}`, 'error');
            }
        }

        async function resetZeroInventoryMonitoring() {
            if (!confirm('Reset zero inventory monitoring?\n\nThis will:\n- Clear zero inventory detection flags\n- Clear all trade logs\n- Restart monitoring for new zero inventory events\n\nContinue?')) return;
            try {
                clearResults();
                log('Resetting zero inventory monitoring...', 'info');
                const result = await apiCall('POST', '/api/galaxy/reset-zero-inventory-monitoring');
                if (result.success && result.data) {
                    log('‚úì Zero inventory monitoring reset successfully', 'success');
                    log(`Status: ${result.data.message}`, 'success');
                    log('Monitoring will now detect new zero inventory events', 'info');
                } else {
                    log(`Failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`Error resetting zero inventory monitoring: ${error.message}`, 'error');
            }
        }

        async function flushState() {
            clearResults();
            log('Flushing state to database...', 'info');
            await apiCall('POST', '/api/flush');
        }

        async function systemOperation() {
            clearResults();
            const systemId = document.getElementById('systemId').value;
            const action = document.getElementById('systemAction').value;
            
            log(`Getting ${action} for system ${systemId}...`, 'info');
            await apiCall('GET', `/api/system/${systemId}?action=${action}`);
        }

        async function compareSystems() {
            clearResults();
            log('Comparing systems 0-5...', 'info');
            const systems = [];
            for (let i = 0; i <= 5; i++) {
                const result = await apiCall('GET', `/api/system/${i}?action=snapshot`);
                if (result.success) {
                    const system = result.data.state;
                    const foodPrice = result.data.markets?.food?.price || 'N/A';
                    systems.push({
                        id: system.id,
                        name: system.name,
                        population: system.population,
                        techLevel: system.techLevel,
                        foodPrice: foodPrice
                    });
                }
            }
            log('\n=== System Comparison ===', 'info');
            log(JSON.stringify(systems, null, 2));
        }

        async function shipOperation() {
            clearResults();
            const shipId = document.getElementById('shipId').value;
            const action = document.getElementById('shipAction').value;
            
            if (action === 'tick') {
                log(`Ticking ship ${shipId}...`, 'info');
                await apiCall('POST', `/api/ship/${shipId}`, { action: 'tick' });
            } else {
                log(`Getting state for ship ${shipId}...`, 'info');
                await apiCall('GET', `/api/ship/${shipId}`);
            }
        }

        async function listShips() {
            clearResults();
            log('Listing ships npc-0 to npc-9...', 'info');
            const ships = [];
            for (let i = 0; i < 10; i++) {
                const result = await apiCall('GET', `/api/ship/npc-${i}`);
                if (result.success && result.data) {
                    ships.push({
                        id: result.data.id,
                        name: result.data.name,
                        system: result.data.currentSystem,
                        credits: result.data.credits,
                        cargo: result.data.cargo || {}
                    });
                }
            }
            log('\n=== Ship List ===', 'info');
            log(JSON.stringify(ships, null, 2));
        }

        async function initializePlayerShip() {
            clearResults();
            const playerId = document.getElementById('playerId').value.trim();
            const name = document.getElementById('playerName').value.trim() || 'Player Ship';
            const systemId = parseInt(document.getElementById('playerSystemId').value, 10);
            const seedInput = document.getElementById('playerSeed').value.trim();
            const seed = seedInput || `player-${Date.now()}`;

            if (!playerId) {
                log('Player ID is required.', 'error');
                return;
            }
            if (Number.isNaN(systemId) || systemId < 0 || systemId > 255) {
                log('System ID must be between 0 and 255.', 'error');
                return;
            }

            const status = document.getElementById('playerManagementStatus');
            status.textContent = `Initializing ${playerId}...`;

            const result = await apiCall('POST', `/api/ship/${playerId}/initialize`, {
                id: playerId,
                name,
                systemId,
                seed,
                isNPC: false
            });

            if (result.success) {
                status.textContent = `Player ${playerId} initialized.`;
            } else {
                status.textContent = `Failed to initialize ${playerId}.`;
            }
        }

        async function loadPlayerState() {
            clearResults();
            const playerId = document.getElementById('playerId').value.trim();
            if (!playerId) {
                log('Player ID is required.', 'error');
                return;
            }
            document.getElementById('playerManagementStatus').textContent = `Loading state for ${playerId}...`;
            const result = await apiCall('GET', `/api/ship/${playerId}`);
            if (result.success) {
                document.getElementById('playerManagementStatus').textContent = `Loaded state for ${playerId}.`;
            } else {
                document.getElementById('playerManagementStatus').textContent = `Failed to load ${playerId}.`;
            }
        }

        async function listPlayers() {
            clearResults();
            log('Listing players player-1 to player-9...', 'info');
            const players = [];
            for (let i = 1; i <= 9; i++) {
                const playerId = `player-${i}`;
                const result = await apiCall('GET', `/api/ship/${playerId}`);
                if (result.success && result.data && result.data.isNPC === false) {
                    players.push({
                        id: result.data.id,
                        name: result.data.name,
                        system: result.data.currentSystem,
                        credits: result.data.credits,
                        cargo: result.data.cargo || {}
                    });
                }
            }
            log('\n=== Player List ===', 'info');
            log(JSON.stringify(players, null, 2));
            document.getElementById('playerManagementStatus').textContent = `Found ${players.length} player ship(s).`;
        }

        function openPlayerUI() {
            window.open('/player', '_blank');
        }

        async function loadPlayerLogs() {
            clearResults();
            log('Loading player logs...', 'info');
            const result = await apiCall('GET', '/api/player-logs');
            if (result.success) {
                log('\n=== Player Logs ===', 'info');
                log(JSON.stringify(result.data.logs, null, 2));
                document.getElementById('playerManagementStatus').textContent = `Loaded ${result.data.logs?.length || 0} log entries.`;
            }
        }

        async function clearPlayerLogs() {
            clearResults();
            log('Clearing player logs...', 'info');
            const result = await apiCall('DELETE', '/api/player-logs');
            if (result.success) {
                document.getElementById('playerManagementStatus').textContent = 'Player logs cleared.';
            }
        }

        async function quickTest() {
            clearResults();
            log('=== Running Quick Test Suite ===', 'info');
            
            log('\n1. Health check...', 'info');
            await apiCall('GET', '/api/health');
            await sleep(500);
            
            log('\n2. Initializing galaxy...', 'info');
            await apiCall('POST', '/api/galaxy/initialize', { seed: `quick-test-${Date.now()}` });
            await sleep(1000);
            
            log('\n3. Getting system 0 snapshot...', 'info');
            await apiCall('GET', '/api/system/0?action=snapshot');
            await sleep(500);
            
            log('\n4. Ticking system 0...', 'info');
            await sleep(500);
            
            log('\n5. Getting ship npc-0 state...', 'info');
            await apiCall('GET', '/api/ship/npc-0');
            await sleep(500);
            
            log('\n6. Experimental trade endpoint removed', 'info');
            
            log('\n=== Quick Test Suite Complete ===', 'success');
        }

        async function priceComparison() {
            clearResults();
            log('Comparing prices across systems 0-9...', 'info');
            const prices = {};
            
            for (let i = 0; i < 10; i++) {
                const result = await apiCall('GET', `/api/system/${i}?action=snapshot`);
                if (result.success && result.data.markets) {
                    prices[`System ${i}`] = {};
                    for (const [goodId, market] of Object.entries(result.data.markets)) {
                        prices[`System ${i}`][goodId] = market.price;
                    }
                }
            }
            
            log('\n=== Price Comparison ===', 'info');
            log(JSON.stringify(prices, null, 2));
        }

        async function marketAnalysis() {
            clearResults();
            log('Analyzing market in system 0...', 'info');
            const result = await apiCall('GET', '/api/system/0?action=snapshot');
            
            if (result.success && result.data) {
                const analysis = {
                    system: {
                        name: result.data.state.name,
                        population: result.data.state.population,
                        techLevel: result.data.state.techLevel,
                        currentTick: result.data.state.currentTick
                    },
                    markets: {}
                };
                
                for (const [goodId, market] of Object.entries(result.data.markets)) {
                    analysis.markets[goodId] = {
                        price: market.price,
                        inventory: market.inventory,
                        production: market.production,
                        consumption: market.consumption,
                        supplyDemandRatio: market.production / (market.consumption || 1)
                    };
                }
                
                log('\n=== Market Analysis ===', 'info');
                log(JSON.stringify(analysis, null, 2));
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function toggleSectionDocs(sectionId) {
            const docs = document.getElementById(sectionId);
            const toggle = event.target;
            if (docs.style.display === 'none') {
                docs.style.display = 'block';
                toggle.textContent = 'üìñ Hide Docs';
            } else {
                docs.style.display = 'none';
                toggle.textContent = 'üìñ Show Docs';
            }
        }

        let loggingConfig = null;

        async function loadApiDocs() {
            try {
                const categories = ['Galaxy Operations', 'System Operations', 'Ship Operations'];
                const docIds = ['galaxyDocs', 'systemDocs', 'shipDocs'];
                
                for (let i = 0; i < categories.length; i++) {
                    const response = await fetch(`/api/docs?category=${encodeURIComponent(categories[i])}`);
                    if (response.ok) {
                        const html = await response.text();
                        document.getElementById(docIds[i]).innerHTML = html;
                    }
                }
            } catch (error) {
                console.warn('Could not load API docs:', error);
            }
        }

        function applyLoggingConfigToUi(config) {
            loggingConfig = config || {};
            const globalEnabled = loggingConfig.enabled !== false;
            const tradeEnabled = loggingConfig.trade?.enabled !== false;
            const playerEnabled = loggingConfig.player?.enabled !== false;
            const shortfallEnabled = loggingConfig.trade?.expectationShortfall?.enabled !== false;
            const shortfallThreshold = loggingConfig.trade?.expectationShortfall?.thresholdCredits ?? 10000;
            const effectiveTradeEnabled = globalEnabled && tradeEnabled;
            const effectivePlayerEnabled = globalEnabled && playerEnabled;
            const effectiveShortfallEnabled = globalEnabled && tradeEnabled && shortfallEnabled;
            const mode = loggingConfig.trade?.mode || 'none';

            const globalBtn = document.getElementById('globalLoggingBtn');
            const globalStatus = document.getElementById('globalLoggingStatus');
            if (globalEnabled) {
                globalBtn.textContent = 'Disable';
                globalBtn.className = 'danger';
                globalStatus.textContent = '‚úÖ Global logging enabled';
                globalStatus.style.color = '#10b981';
            } else {
                globalBtn.textContent = 'Enable';
                globalBtn.className = 'success';
                globalStatus.textContent = 'üîá Global logging disabled';
                globalStatus.style.color = '#f87171';
            }

            const tradeBtn = document.getElementById('tradeLoggingEnabledBtn');
            const tradeStatus = document.getElementById('tradeLoggingEnabledStatus');
            if (tradeEnabled) {
                tradeBtn.textContent = 'Disable';
                tradeBtn.className = 'danger';
            } else {
                tradeBtn.textContent = 'Enable';
                tradeBtn.className = 'success';
            }
            if (!globalEnabled) {
                tradeStatus.textContent = '‚õî Disabled by global switch';
                tradeStatus.style.color = '#f87171';
            } else if (effectiveTradeEnabled) {
                tradeStatus.textContent = '‚úÖ Trade logging enabled';
                tradeStatus.style.color = '#10b981';
            } else {
                tradeStatus.textContent = 'üîá Trade logging disabled';
                tradeStatus.style.color = '#f87171';
            }

            const playerBtn = document.getElementById('playerLoggingEnabledBtn');
            const playerStatus = document.getElementById('playerLoggingEnabledStatus');
            if (playerEnabled) {
                playerBtn.textContent = 'Disable';
                playerBtn.className = 'danger';
            } else {
                playerBtn.textContent = 'Enable';
                playerBtn.className = 'success';
            }
            if (!globalEnabled) {
                playerStatus.textContent = '‚õî Disabled by global switch';
                playerStatus.style.color = '#f87171';
            } else if (effectivePlayerEnabled) {
                playerStatus.textContent = '‚úÖ Player logging enabled';
                playerStatus.style.color = '#10b981';
            } else {
                playerStatus.textContent = 'üîá Player logging disabled';
                playerStatus.style.color = '#f87171';
            }

            const shortfallBtn = document.getElementById('shortfallLoggingEnabledBtn');
            const shortfallStatus = document.getElementById('shortfallLoggingEnabledStatus');
            const shortfallInput = document.getElementById('shortfallThresholdInput');
            if (shortfallEnabled) {
                shortfallBtn.textContent = 'Disable';
                shortfallBtn.className = 'danger';
            } else {
                shortfallBtn.textContent = 'Enable';
                shortfallBtn.className = 'success';
            }
            shortfallInput.value = shortfallThreshold;
            if (!globalEnabled) {
                shortfallStatus.textContent = '‚õî Disabled by global switch';
                shortfallStatus.style.color = '#f87171';
            } else if (!tradeEnabled) {
                shortfallStatus.textContent = '‚õî Disabled by trade log capture';
                shortfallStatus.style.color = '#f87171';
            } else if (effectiveShortfallEnabled) {
                shortfallStatus.textContent = `‚úÖ File logging enabled (‚â• ${shortfallThreshold} cr)`;
                shortfallStatus.style.color = '#10b981';
            } else {
                shortfallStatus.textContent = 'üîá File logging disabled';
                shortfallStatus.style.color = '#f87171';
            }

            const statusEl = document.getElementById('tradeLoggingStatus');
            const selectEl = document.getElementById('tradeLoggingMode');
            if (!globalEnabled || !tradeEnabled) {
                statusEl.textContent = 'üîá Trade logging disabled';
            } else if (mode === 'all') {
                statusEl.textContent = '‚úÖ Logging all traders';
            } else if (mode === 'none') {
                statusEl.textContent = 'üîá Logging disabled';
            } else {
                statusEl.textContent = `üéØ Logging only: ${mode}`;
            }

            if (mode === 'all' || mode === 'none') {
                selectEl.value = mode;
                document.getElementById('customShipIdGroup').style.display = 'none';
            } else {
                selectEl.value = 'custom';
                document.getElementById('customShipIdGroup').style.display = 'block';
                document.getElementById('customShipId').value = mode;
            }

            if (mode.startsWith('npc-')) {
                monitoredShipId = mode;
                document.getElementById('decisionMonitorShipId').value = mode;
                const decisionStatus = document.getElementById('decisionMonitorStatus');
                if (!globalEnabled || !tradeEnabled) {
                    decisionStatus.textContent = `‚ö† Monitoring paused: ${mode}`;
                    decisionStatus.style.color = '#f59e0b';
                } else {
                    decisionStatus.textContent = `‚úÖ Monitoring: ${mode}`;
                    decisionStatus.style.color = '#10b981';
                }
            }
        }

        async function loadLoggingConfig() {
            try {
                const result = await apiCall('GET', '/api/logging');
                if (result.success) {
                    applyLoggingConfigToUi(result.data.config || result.data);
                }
            } catch (error) {
                document.getElementById('globalLoggingStatus').textContent = '‚ö†Ô∏è Could not load status';
            }
        }

        async function updateLoggingConfig(updates) {
            try {
                const result = await apiCall('POST', '/api/logging', updates);
                if (result.success) {
                    applyLoggingConfigToUi(result.data.config || result.data);
                }
            } catch (error) {
                log(`Error updating logging config: ${error.message}`, 'error');
            }
        }

        async function toggleGlobalLogging() {
            const enabled = !(loggingConfig && loggingConfig.enabled !== false);
            await updateLoggingConfig({ enabled });
        }

        async function toggleTradeLoggingEnabled() {
            const current = loggingConfig?.trade?.enabled !== false;
            await updateLoggingConfig({ trade: { enabled: !current } });
        }

        async function togglePlayerLoggingEnabled() {
            const current = loggingConfig?.player?.enabled !== false;
            await updateLoggingConfig({ player: { enabled: !current } });
        }

        async function toggleExpectationShortfallLoggingEnabled() {
            const current = loggingConfig?.trade?.expectationShortfall?.enabled !== false;
            await updateLoggingConfig({ trade: { expectationShortfall: { enabled: !current } } });
        }

        async function updateExpectationShortfallThreshold() {
            const input = document.getElementById('shortfallThresholdInput');
            const thresholdCredits = Number(input.value);
            if (!Number.isFinite(thresholdCredits) || thresholdCredits < 0) {
                log('Threshold must be a non-negative number', 'error');
                return;
            }
            await updateLoggingConfig({ trade: { expectationShortfall: { thresholdCredits } } });
        }

        async function updateTradeLogging() {
            const mode = document.getElementById('tradeLoggingMode').value;
            const customGroup = document.getElementById('customShipIdGroup');
            
            if (mode === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
                await setTradeLoggingMode(mode);
            }
        }

        async function setCustomTradeLogging() {
            const shipId = document.getElementById('customShipId').value.trim();
            if (!shipId) {
                log('Please enter a ship ID', 'error');
                return;
            }
            await setTradeLoggingMode(shipId);
        }

        async function setTradeLoggingMode(mode) {
            try {
                const result = await apiCall('POST', '/api/trade-logging', { mode });
                if (result.success) {
                    await loadLoggingConfig();
                }
            } catch (error) {
                log(`Error setting trade logging: ${error.message}`, 'error');
            }
        }

        async function loadTradeLoggingStatus() {
            await loadLoggingConfig();
        }

        async function loadNavigationConfig() {
            const status = document.getElementById('navConfigStatus');
            if (status) status.textContent = 'Loading navigation config...';
            try {
                const result = await apiCall('GET', '/api/navigation-config');
                if (result.success && result.data?.config) {
                    const config = result.data.config;
                    const enabledSelect = document.getElementById('navFuelEnabled');
                    const rateInput = document.getElementById('navFuelRate');
                    if (enabledSelect) enabledSelect.value = String(Boolean(config.inSystemFuelEnabled));
                    if (rateInput && Number.isFinite(config.inSystemFuelRate)) {
                        rateInput.value = config.inSystemFuelRate.toFixed(2);
                    }
                    if (status) status.textContent = 'Navigation config loaded.';
                } else if (status) {
                    status.textContent = result.error || 'Failed to load navigation config.';
                }
            } catch (error) {
                if (status) status.textContent = `Error loading navigation config: ${error.message}`;
            }
        }

        async function saveNavigationConfig() {
            const status = document.getElementById('navConfigStatus');
            const enabledSelect = document.getElementById('navFuelEnabled');
            const rateInput = document.getElementById('navFuelRate');
            const enabled = enabledSelect ? enabledSelect.value === 'true' : false;
            const rateValue = rateInput ? parseFloat(rateInput.value) : 0;
            if (!Number.isFinite(rateValue) || rateValue < 0) {
                if (status) status.textContent = 'Fuel rate must be a non-negative number.';
                return;
            }
            if (status) status.textContent = 'Saving navigation config...';
            try {
                const result = await apiCall('POST', '/api/navigation-config', {
                    inSystemFuelEnabled: enabled,
                    inSystemFuelRate: rateValue
                });
                if (result.success && result.data?.config) {
                    if (status) status.textContent = 'Navigation config saved.';
                } else if (status) {
                    status.textContent = result.error || 'Failed to save navigation config.';
                }
            } catch (error) {
                if (status) status.textContent = `Error saving navigation config: ${error.message}`;
            }
        }

        let autoRefreshLogsInterval = null;
        let autoRefreshDecisionLogsInterval = null;
        let monitoredShipId = null;
        
        let isLoadingLogs = false;
        async function loadTradeLogs() {
            if (isLoadingLogs) return;
            
            try {
                isLoadingLogs = true;
                const result = await apiCall('GET', '/api/trade-logs');
                if (result.success && result.data) {
                    const logs = result.data.logs || [];
                    const container = document.getElementById('tradeLogsContainer');
                    
                    if (logs.length === 0) {
                        container.innerHTML = '<div style="color: #aaa;">No trade logs yet</div>';
                        return;
                    }
                    
                    const fragment = document.createDocumentFragment();
                    logs.forEach(log => {
                        const div = document.createElement('div');
                        const date = new Date(log.timestamp);
                        const timeStr = date.toLocaleTimeString();
                        div.textContent = `[${timeStr}] ${log.message}`;
                        div.style.color = '#10b981';
                        div.style.marginBottom = '4px';
                        fragment.appendChild(div);
                    });
                    
                    container.innerHTML = '';
                    container.appendChild(fragment);
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                log(`Error loading trade logs: ${error.message}`, 'error');
            } finally {
                isLoadingLogs = false;
            }
        }
        
        async function clearTradeLogs() {
            try {
                const result = await apiCall('DELETE', '/api/trade-logs');
                if (result.success) {
                    document.getElementById('tradeLogsContainer').innerHTML = '<div style="color: #aaa;">Logs cleared</div>';
                    log('Trade logs cleared', 'success');
                }
            } catch (error) {
                log(`Error clearing trade logs: ${error.message}`, 'error');
            }
        }
        
        function toggleAutoRefreshLogs() {
            const btn = document.getElementById('autoRefreshLogsBtn');
            if (autoRefreshLogsInterval) {
                clearInterval(autoRefreshLogsInterval);
                autoRefreshLogsInterval = null;
                btn.textContent = 'Auto-Refresh: OFF';
            } else {
                autoRefreshLogsInterval = setInterval(() => {
                    loadTradeLogs();
                }, 5000);
                btn.textContent = 'Auto-Refresh: ON';
                loadTradeLogs();
            }
        }

        async function enableDecisionMonitoring() {
            const shipId = document.getElementById('decisionMonitorShipId').value.trim();
            if (!shipId) {
                alert('Please enter an NPC ship ID (e.g., npc-447)');
                return;
            }
            
            try {
                const result = await apiCall('POST', '/api/trade-logging', { mode: shipId });
                if (result.success) {
                    monitoredShipId = shipId;
                    document.getElementById('decisionMonitorStatus').textContent = `‚úÖ Monitoring: ${shipId}`;
                    document.getElementById('decisionMonitorStatus').style.color = '#10b981';
                    loadDecisionLogs();
                    loadTradeLoggingStatus();
                    log(`Decision monitoring enabled for ${shipId}`, 'success');
                }
            } catch (error) {
                log(`Error enabling decision monitoring: ${error.message}`, 'error');
            }
        }
        
        async function disableDecisionMonitoring() {
            try {
                const result = await apiCall('POST', '/api/trade-logging', { mode: 'none' });
                if (result.success) {
                    monitoredShipId = null;
                    document.getElementById('decisionMonitorStatus').textContent = 'Not monitoring any NPC';
                    document.getElementById('decisionMonitorStatus').style.color = '#93a4b7';
                    document.getElementById('decisionLogsContainer').innerHTML = '<div style="color: #aaa;">Monitoring disabled</div>';
                    loadTradeLoggingStatus();
                    log('Decision monitoring disabled', 'success');
                }
            } catch (error) {
                log(`Error disabling decision monitoring: ${error.message}`, 'error');
            }
        }
        
        let isLoadingDecisionLogs = false;
        async function loadDecisionLogs() {
            if (isLoadingDecisionLogs) return;
            
            try {
                isLoadingDecisionLogs = true;
                const result = await apiCall('GET', '/api/trade-logs');
                if (result.success && result.data) {
                    const logs = result.data.logs || [];
                    const container = document.getElementById('decisionLogsContainer');
                    
                    const decisionLogs = logs.filter(log => log.message && log.message.includes('[DECISION'));
                    
                    if (decisionLogs.length === 0) {
                        container.innerHTML = '<div style="color: #aaa;">No decision logs yet. Enable monitoring for an NPC and wait for them to make decisions.</div>';
                        return;
                    }
                    
                    const fragment = document.createDocumentFragment();
                    decisionLogs.forEach(log => {
                        const div = document.createElement('div');
                        const date = new Date(log.timestamp);
                        const timeStr = date.toLocaleTimeString();
                        
                        const message = log.message.replace(/\[DECISION [^\]]+\] /, '');
                        
                        let color = '#10b981';
                        if (message.includes('DECISION:')) {
                            color = '#60a5fa';
                        } else if (message.includes('ACTION:')) {
                            color = '#ffaa00';
                        } else if (message.includes('RESULT:')) {
                            color = message.includes('SUCCESS') ? '#10b981' : '#f87171';
                        } else if (message.includes('FALLBACK:')) {
                            color = '#f87171';
                        } else if (message.includes('WARNING:') || message.includes('ERROR:')) {
                            color = '#f87171';
                        } else if (message.startsWith('  ')) {
                            color = '#93a4b7';
                        }
                        
                        div.innerHTML = `<span style="color: #666;">[${timeStr}]</span> <span style="color: ${color};">${message}</span>`;
                        div.style.marginBottom = '3px';
                        fragment.appendChild(div);
                    });
                    
                    container.innerHTML = '';
                    container.appendChild(fragment);
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                log(`Error loading decision logs: ${error.message}`, 'error');
            } finally {
                isLoadingDecisionLogs = false;
            }
        }
        
        async function clearDecisionLogs() {
            try {
                const result = await apiCall('DELETE', '/api/trade-logs');
                if (result.success) {
                    document.getElementById('decisionLogsContainer').innerHTML = '<div style="color: #aaa;">Decision logs cleared</div>';
                    log('Decision logs cleared', 'success');
                }
            } catch (error) {
                log(`Error clearing decision logs: ${error.message}`, 'error');
            }
        }
        
        function toggleAutoRefreshDecisionLogs() {
            const btn = document.getElementById('autoRefreshDecisionLogsBtn');
            if (autoRefreshDecisionLogsInterval) {
                clearInterval(autoRefreshDecisionLogsInterval);
                autoRefreshDecisionLogsInterval = null;
                btn.textContent = 'Auto-Refresh: OFF';
                btn.style.background = '#60a5fa';
            } else {
                autoRefreshDecisionLogsInterval = setInterval(loadDecisionLogs, 2000);
                btn.textContent = 'Auto-Refresh: ON';
                btn.style.background = '#10b981';
                loadDecisionLogs();
            }
        }

        async function collectMonitoringData() {
            try {
                log('Triggering manual data collection...', 'info');
                const result = await apiCall('POST', '/api/monitoring/collect');
                if (result.success) {
                    log('Data collection triggered successfully', 'success');
                    updateMonitoringStatus('Data collection triggered');
                }
            } catch (error) {
                log(`Error collecting monitoring data: ${error.message}`, 'error');
            }
        }

        async function viewMonitoringData() {
            try {
                log('Loading monitoring data...', 'info');
                const result = await apiCall('GET', '/api/monitoring/data');
                if (result.success && result.data) {
                    const data = result.data;
                    const summary = {
                        monitoringDuration: `${Math.floor((Date.now() - data.startTime) / 1000 / 60)} minutes`,
                        lastCollection: data.lastCollectionTime ? new Date(data.lastCollectionTime).toLocaleString() : 'Never',
                        shipMetrics: data.shipMetrics.length,
                        systemMetrics: data.systemMetrics.length,
                        galaxyMetrics: data.galaxyMetrics.length,
                    };
                    
                    const resultsDiv = document.getElementById('monitoringResults');
                    const contentDiv = document.getElementById('monitoringResultsContent');
                    resultsDiv.style.display = 'block';
                    
                    let output = '=== Monitoring Data Summary ===\n\n';
                    output += JSON.stringify(summary, null, 2);
                    output += '\n\n=== Latest Galaxy Metrics ===\n\n';
                    if (data.galaxyMetrics.length > 0) {
                        const latest = data.galaxyMetrics[data.galaxyMetrics.length - 1];
                        output += JSON.stringify(latest, null, 2);
                    } else {
                        output += 'No galaxy metrics collected yet.\n';
                    }
                    
                    contentDiv.textContent = output;
                    log('Monitoring data loaded', 'success');
                }
            } catch (error) {
                log(`Error loading monitoring data: ${error.message}`, 'error');
            }
        }

        async function analyzeMonitoring() {
            try {
                log('Analyzing monitoring data...', 'info');
                const result = await apiCall('GET', '/api/monitoring/analyze');
                if (result.success && result.analysis) {
                    const analysis = result.analysis;
                    const resultsDiv = document.getElementById('monitoringResults');
                    const contentDiv = document.getElementById('monitoringResultsContent');
                    resultsDiv.style.display = 'block';
                    
                    let output = '=== Economic Analysis & Recommendations ===\n\n';
                    
                    output += 'üìà STATISTICS\n';
                    output += `Monitoring Duration: ${Math.floor(analysis.statistics.monitoringDuration / 1000 / 60)} minutes\n`;
                    output += `Data Points Collected: ${analysis.statistics.dataPoints}\n`;
                    output += `Average Wealth Growth: ${analysis.statistics.averageWealthGrowth.toFixed(2)} cr/min\n`;
                    output += `Max Wealth Growth: ${analysis.statistics.maxWealthGrowth.toFixed(2)} cr/min\n`;
                    output += '\n';
                    
                    if (analysis.issues.length === 0) {
                        output += '‚úÖ No issues detected. Economy appears balanced.\n\n';
                    } else {
                        output += `‚ö†Ô∏è ISSUES FOUND (${analysis.issues.length})\n\n`;
                        
                        const critical = analysis.issues.filter(i => i.severity === 'critical');
                        const warnings = analysis.issues.filter(i => i.severity === 'warning');
                        const info = analysis.issues.filter(i => i.severity === 'info');
                        
                        if (critical.length > 0) {
                            output += 'üî¥ CRITICAL ISSUES:\n';
                            critical.forEach((issue, idx) => {
                                output += `\n${idx + 1}. [${issue.category}] ${issue.message}\n`;
                                output += `   üí° Recommendation: ${issue.recommendation}\n`;
                            });
                            output += '\n';
                        }
                        
                        if (warnings.length > 0) {
                            output += 'üü° WARNINGS:\n';
                            warnings.forEach((issue, idx) => {
                                output += `\n${idx + 1}. [${issue.category}] ${issue.message}\n`;
                                output += `   üí° Recommendation: ${issue.recommendation}\n`;
                            });
                            output += '\n';
                        }
                        
                        if (info.length > 0) {
                            output += '‚ÑπÔ∏è INFO:\n';
                            info.forEach((issue, idx) => {
                                output += `\n${idx + 1}. [${issue.category}] ${issue.message}\n`;
                                output += `   üí° Recommendation: ${issue.recommendation}\n`;
                            });
                            output += '\n';
                        }
                    }
                    
                    if (Object.keys(analysis.statistics.priceVolatility).length > 0) {
                        output += 'üìä PRICE VOLATILITY BY GOOD:\n';
                        for (const [goodId, volatility] of Object.entries(analysis.statistics.priceVolatility)) {
                            output += `  ${goodId}: ${volatility.toFixed(2)}%\n`;
                        }
                    }
                    
                    contentDiv.textContent = output;
                    log('Analysis complete', 'success');
                    updateMonitoringStatus(`Analysis complete: ${analysis.issues.length} issues found`);
                }
            } catch (error) {
                log(`Error analyzing monitoring data: ${error.message}`, 'error');
            }
        }

        async function getGalacticHealth() {
            try {
                const result = await apiCall('GET', '/api/galaxy-health');
                if (result.success && result.data) {
                    const health = result.data.health;
                    const statusDiv = document.getElementById('galacticHealthStatus');
                    const resultsDiv = document.getElementById('galacticHealthResults');
                    const contentDiv = document.getElementById('galacticHealthResultsContent');
                    
                    resultsDiv.style.display = 'block';
                    
                    let output = 'üè• GALACTIC HEALTH REPORT\n';
                    output += '='.repeat(50) + '\n\n';
                    
                    const statusColor = health.health.status === 'healthy' ? '‚úì' : 
                                       health.health.status === 'warning' ? '‚ö†' : '‚úó';
                    output += `Status: ${statusColor} ${health.health.status.toUpperCase()}\n\n`;
                    
                    if (health.health.issues.length > 0) {
                        output += 'Issues:\n';
                        health.health.issues.forEach((issue, idx) => {
                            output += `  ${idx + 1}. ${issue}\n`;
                        });
                        output += '\n';
                    }
                    
                    output += 'POPULATION:\n';
                    output += `  Current: ${health.population.current.toLocaleString()}\n`;
                    output += `  Target: ${health.population.target.toLocaleString()}\n`;
                    output += `  Active: ${health.population.active.toLocaleString()}\n`;
                    output += `  Inactive: ${health.population.inactive.toLocaleString()}\n\n`;
                    
                    output += 'SHIPS:\n';
                    output += `  Total Spawns: ${health.ships.totalSpawns}\n`;
                    output += `  Total Removals: ${health.ships.totalRemovals}\n`;
                    
                    // Format duration
                    let durationMs = health.durationMs;
                    if (!durationMs && health.serverStartTime) {
                        durationMs = Date.now() - health.serverStartTime;
                    }
                    // Fallback if duration is still invalid
                    if (!durationMs || isNaN(durationMs) || durationMs < 0) {
                        durationMs = 0;
                    }
                    const hours = Math.floor(durationMs / (60 * 60 * 1000));
                    const minutes = Math.floor((durationMs % (60 * 60 * 1000)) / (60 * 1000));
                    const seconds = Math.floor((durationMs % (60 * 1000)) / 1000);
                    let durationStr = '';
                    if (hours > 0) {
                        durationStr = `${hours}h ${minutes}m ${seconds}s`;
                    } else if (minutes > 0) {
                        durationStr = `${minutes}m ${seconds}s`;
                    } else {
                        durationStr = `${seconds}s`;
                    }
                    
                    output += `  Spawns (Since Start - ${durationStr}): ${health.ships.spawnsSinceStart}\n`;
                    output += `  Removals (Since Start - ${durationStr}): ${health.ships.removalsSinceStart}\n`;
                    output += `  Net Growth: ${health.ships.netGrowth >= 0 ? '+' : ''}${health.ships.netGrowth}\n\n`;
                    
                    if (Object.keys(health.ships.removalReasons).length > 0) {
                        output += 'Removal Reasons:\n';
                        for (const [reason, count] of Object.entries(health.ships.removalReasons)) {
                            output += `  ${reason}: ${count}\n`;
                        }
                        output += '\n';
                    }
                    
                    output += `TRADES (Since Start - ${durationStr}):\n`;
                    output += `  Total: ${health.trades.totalTrades}\n`;
                    output += `  Successful Buys: ${health.trades.successfulBuys}\n`;
                    output += `  Successful Sells: ${health.trades.successfulSells}\n`;
                    output += `  Failed: ${health.trades.failedTrades}\n`;
                    output += `  Profitable: ${health.trades.profitableTrades}\n`;
                    output += `  Unprofitable: ${health.trades.unprofitableTrades}\n`;
                    output += `  Total Profit: ${health.trades.totalProfit.toLocaleString()} cr\n`;
                    output += `  Total Loss: ${health.trades.totalLoss.toLocaleString()} cr\n`;
                    
                    contentDiv.textContent = output;
                    statusDiv.textContent = `Last updated: ${new Date(health.timestamp).toLocaleString()}`;
                    log('Galactic health data loaded', 'success');
                }
            } catch (error) {
                log(`Error getting galactic health: ${error.message}`, 'error');
            }
        }

        async function clearMonitoringData() {
            if (!confirm('Clear all monitoring data? This cannot be undone.')) {
                return;
            }
            try {
                const result = await apiCall('POST', '/api/monitoring/clear');
                if (result.success) {
                    log('Monitoring data cleared', 'success');
                    updateMonitoringStatus('Monitoring data cleared');
                    document.getElementById('monitoringResults').style.display = 'none';
                }
            } catch (error) {
                log(`Error clearing monitoring data: ${error.message}`, 'error');
            }
        }

        function updateMonitoringStatus(message) {
            document.getElementById('monitoringStatus').textContent = message;
        }

        async function loadAutoTickStatus() {
            try {
                const result = await apiCall('GET', '/api/auto-tick');
                if (result.success) {
                    const status = result.data;
                    const btn = document.getElementById('autoTickBtn');
                    const statusEl = document.getElementById('autoTickStatus');
                    
                    if (status.enabled) {
                        btn.textContent = 'Disable Auto-Tick';
                        btn.style.background = '#ff4a4a';
                        statusEl.textContent = `Enabled (every ${status.interval / 1000}s)`;
                        statusEl.style.color = '#10b981';
                    } else {
                        btn.textContent = 'Enable Auto-Tick';
                        btn.style.background = '#60a5fa';
                        statusEl.textContent = 'Disabled';
                        statusEl.style.color = '#93a4b7';
                    }
                }
            } catch (error) {
                document.getElementById('autoTickStatus').textContent = '‚ö†Ô∏è Could not load status';
                document.getElementById('autoTickBtn').textContent = 'Toggle Auto-Tick';
            }
        }
        
        async function toggleAutoTick() {
            try {
                const result = await apiCall('GET', '/api/auto-tick');
                if (result.success) {
                    const currentStatus = result.data.enabled;
                    const newStatus = !currentStatus;
                    
                    const toggleResult = await apiCall('POST', '/api/auto-tick', { enabled: newStatus });
                    if (toggleResult.success) {
                        loadAutoTickStatus();
                        log(`Auto-tick ${newStatus ? 'enabled' : 'disabled'}`, 'success');
                    }
                }
            } catch (error) {
                log(`Error toggling auto-tick: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('Dev Testing Interface Ready', 'success');
        log(`API Base: ${API_BASE}`, 'info');
        loadTradeLoggingStatus();
        loadNavigationConfig();
        loadAutoTickStatus();
        loadApiDocs();
    </script>
</body>
</html>
