<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0b1016">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Space Trader - Galactic Leaderboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0b1016;
            --panel: #0f1724;
            --panel-border: rgba(45, 212, 191, 0.3);
            --text: #e2e8f0;
            --muted: #93a4b7;
            --accent: #2dd4bf;
            --accent-strong: #10b981;
            --danger: #f87171;
            --info: #60a5fa;
        }
        html, body { background: var(--bg); }
        body { 
            font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: calc(20px + env(safe-area-inset-top)) 20px calc(20px + env(safe-area-inset-bottom)); 
            background: radial-gradient(circle at top, rgba(45, 212, 191, 0.08), transparent 45%),
                        radial-gradient(circle at 20% 20%, rgba(96, 165, 250, 0.12), transparent 35%),
                        linear-gradient(135deg, #0b1016 0%, #0f1724 50%, #0b1016 100%);
            background-color: #0b1016;
            color: var(--text); 
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { 
            color: var(--accent); 
            margin-bottom: 10px; 
            font-size: 32px;
        }
        .subtitle {
            color: var(--muted);
            margin-bottom: 30px;
            font-size: 14px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--panel-border);
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button { 
            padding: 10px 20px; 
            background: var(--accent); 
            color: #04121a; 
            border: none; 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }
        button:hover { 
            background: #5eead4; 
            transform: translateY(-1px);
        }
        button.danger { 
            background: var(--danger); 
            color: white;
        }
        button.danger:hover { 
            background: #ff8f8f; 
        }
        button.secondary {
            background: #1f2a3a;
            color: white;
        }
        button.secondary:hover {
            background: #2a3b52;
        }
        .section { 
            background: var(--panel); 
            padding: 20px; 
            margin-bottom: 20px; 
            border: 1px solid var(--panel-border); 
            border-radius: 12px;
        }
        h2 { 
            color: var(--accent); 
            margin: 0 0 15px 0; 
            font-size: 20px;
            border-bottom: 1px solid var(--panel-border);
            padding-bottom: 10px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--panel-border);
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: var(--muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab:hover {
            color: var(--accent);
        }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th {
            background: rgba(45, 212, 191, 0.12);
            color: var(--accent);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            color: var(--text);
        }
        tr:hover {
            background: rgba(45, 212, 191, 0.08);
        }
        .rank {
            font-weight: 700;
            color: var(--accent);
            width: 50px;
        }
        .number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .status.loading {
            background: #1f2a3a;
            color: var(--text);
        }
        .status.error {
            background: var(--danger);
            color: white;
        }
        .status.success {
            background: var(--accent-strong);
            color: white;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-style: italic;
        }
        .link {
            color: var(--accent);
            text-decoration: none;
            margin-left: 15px;
        }
        .link:hover {
            text-decoration: underline;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(45, 212, 191, 0.08);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--panel-border);
        }
        .stat-label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìä Galactic Leaderboard</h1>
                <div class="subtitle">Top traders, best systems, and popular trade routes</div>
            </div>
            <div class="controls">
                <button onclick="loadLeaderboard()">üîÑ Refresh</button>
                <button onclick="clearLeaderboard()" class="danger">üóëÔ∏è Clear Data</button>
                <a href="dev.html" class="link">‚Üê Back to Dev</a>
            </div>
        </div>

        <div id="status" class="status loading">Loading...</div>

        <div id="leaderboardContent" style="display: none;">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('traders')">Traders</div>
                <div class="tab" onclick="switchTab('systems')">Systems</div>
                <div class="tab" onclick="switchTab('routes')">Trade Routes</div>
            </div>

            <div id="tradersTab" class="tab-content active">
                <div class="tabs" style="margin-top: 0;">
                    <div class="tab active" onclick="switchTraderTab('credits')">By Credits</div>
                    <div class="tab" onclick="switchTraderTab('ticks')">By Ticks</div>
                    <div class="tab" onclick="switchTraderTab('trades')">By Trades</div>
                    <div class="tab" onclick="switchTraderTab('profit')">By Profit</div>
                    <div class="tab" onclick="switchTraderTab('volume')">By Volume</div>
                </div>
                <div id="tradersContent"></div>
            </div>

            <div id="systemsTab" class="tab-content">
                <div class="tabs" style="margin-top: 0;">
                    <div class="tab active" onclick="switchSystemTab('volume')">By Trade Volume</div>
                    <div class="tab" onclick="switchSystemTab('trades')">By Trades</div>
                    <div class="tab" onclick="switchSystemTab('traders')">By Unique Traders</div>
                    <div class="tab" onclick="switchSystemTab('profit')">By Profit</div>
                </div>
                <div id="systemsContent"></div>
            </div>

            <div id="routesTab" class="tab-content">
                <div id="routesContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let leaderboardData = null;
        let currentTraderTab = 'credits';
        let currentSystemTab = 'volume';

        function updateStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        async function loadLeaderboard() {
            updateStatus('Loading leaderboard...', 'loading');
            try {
                const response = await fetch(`${API_BASE}/api/leaderboard?limit=100`);
                const data = await response.json();
                
                if (data.success && data.leaderboard) {
                    leaderboardData = data.leaderboard;
                    updateStatus('‚úì Loaded successfully', 'success');
                    document.getElementById('leaderboardContent').style.display = 'block';
                    renderLeaderboard();
                } else {
                    updateStatus('‚úó Error loading leaderboard', 'error');
                }
            } catch (error) {
                updateStatus(`‚úó Error: ${error.message}`, 'error');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tab}Tab`).classList.add('active');
        }

        function switchTraderTab(tab) {
            currentTraderTab = tab;
            document.querySelectorAll('#tradersTab .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderTraders();
        }

        function switchSystemTab(tab) {
            currentSystemTab = tab;
            document.querySelectorAll('#systemsTab .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderSystems();
        }

        function renderLeaderboard() {
            renderTraders();
            renderSystems();
            renderRoutes();
        }

        function renderTraders() {
            if (!leaderboardData) return;
            
            const data = leaderboardData.traders[`by${currentTraderTab.charAt(0).toUpperCase() + currentTraderTab.slice(1)}`] || [];
            const container = document.getElementById('tradersContent');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">No trader data available</div>';
                return;
            }

            const headers = {
                credits: ['Rank', 'Ship ID', 'Name', 'Credits'],
                ticks: ['Rank', 'Ship ID', 'Name', 'Total Ticks'],
                trades: ['Rank', 'Ship ID', 'Name', 'Total Trades'],
                profit: ['Rank', 'Ship ID', 'Name', 'Total Profit'],
                volume: ['Rank', 'Ship ID', 'Name', 'Total Volume']
            };

            const field = currentTraderTab;
            const fieldLabel = field === 'credits' ? 'Credits' : 
                             field === 'ticks' ? 'Ticks' : 
                             field === 'trades' ? 'Trades' : 
                             field === 'profit' ? 'Profit (cr)' : 'Volume (cr)';

            let html = '<table><thead><tr>';
            headers[field].forEach(h => {
                html += `<th>${h}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.forEach((item, index) => {
                const value = item[field] || item.credits || item.ticks || item.trades || item.profit || item.volume || 0;
                html += `<tr>
                    <td class="rank">#${index + 1}</td>
                    <td><a href="#" onclick="viewTraderDetails('${item.shipId}'); return false;" style="color: #2dd4bf; text-decoration: none;">${item.shipId}</a></td>
                    <td>${item.name || 'Unknown'}</td>
                    <td class="number">${typeof value === 'number' ? value.toLocaleString() : value}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderSystems() {
            if (!leaderboardData) return;
            
            const data = leaderboardData.systems[`by${currentSystemTab === 'traders' ? 'UniqueTraders' : currentSystemTab.charAt(0).toUpperCase() + currentSystemTab.slice(1)}`] || [];
            const container = document.getElementById('systemsContent');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">No system data available</div>';
                return;
            }

            const field = currentSystemTab;
            const fieldLabel = field === 'volume' ? 'Trade Volume' : 
                             field === 'trades' ? 'Total Trades' : 
                             field === 'traders' ? 'Unique Traders' : 'Total Profit';

            let html = '<table><thead><tr><th>Rank</th><th>System ID</th><th>Name</th><th>' + fieldLabel + '</th></tr></thead><tbody>';

            data.forEach((item, index) => {
                const value = item[field] || item.volume || item.trades || item.traders || item.profit || 0;
                html += `<tr>
                    <td class="rank">#${index + 1}</td>
                    <td><a href="#" onclick="viewSystemDetails(${item.systemId}); return false;" style="color: #2dd4bf; text-decoration: none;">System ${item.systemId}</a></td>
                    <td>${item.name || `System ${item.systemId}`}</td>
                    <td class="number">${typeof value === 'number' ? value.toLocaleString() : value}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderRoutes() {
            if (!leaderboardData) return;
            
            const data = leaderboardData.routes || [];
            const container = document.getElementById('routesContent');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">No trade route data available</div>';
                return;
            }

            let html = '<table><thead><tr><th>Rank</th><th>From System</th><th>To System</th><th>Trade Count</th><th>Volume</th><th>Profit</th><th>Unique Traders</th></tr></thead><tbody>';

            data.forEach((item, index) => {
                html += `<tr>
                    <td class="rank">#${index + 1}</td>
                    <td>System ${item.fromSystem}</td>
                    <td>System ${item.toSystem}</td>
                    <td class="number">${item.tradeCount.toLocaleString()}</td>
                    <td class="number">${item.volume.toLocaleString()}</td>
                    <td class="number">${item.profit.toLocaleString()}</td>
                    <td class="number">${item.traders}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function viewTraderDetails(shipId) {
            try {
                const response = await fetch(`${API_BASE}/api/leaderboard/trader/${shipId}`);
                const data = await response.json();
                if (data.success) {
                    alert(`Trader Details:\n\n` +
                          `Ship ID: ${data.trader.shipId}\n` +
                          `Name: ${data.trader.name}\n` +
                          `Current Credits: ${data.trader.currentCredits.toLocaleString()}\n` +
                          `Peak Credits: ${data.trader.peakCredits.toLocaleString()}\n` +
                          `Total Ticks: ${data.trader.totalTicks}\n` +
                          `Total Trades: ${data.trader.totalTrades}\n` +
                          `Successful Trades: ${data.trader.successfulTrades}\n` +
                          `Total Profit: ${data.trader.totalProfit.toLocaleString()} cr\n` +
                          `Total Volume: ${data.trader.totalVolume.toLocaleString()} cr\n` +
                          `Systems Visited: ${data.trader.systemsVisited.length}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function viewSystemDetails(systemId) {
            try {
                const response = await fetch(`${API_BASE}/api/leaderboard/system/${systemId}`);
                const data = await response.json();
                if (data.success) {
                    alert(`System Details:\n\n` +
                          `System ID: ${data.system.systemId}\n` +
                          `Name: ${data.system.name}\n` +
                          `Total Trade Volume: ${data.system.totalTradeVolume.toLocaleString()} cr\n` +
                          `Total Trades: ${data.system.totalTrades}\n` +
                          `Unique Traders: ${data.system.uniqueTraders.length}\n` +
                          `Total Profit: ${data.system.totalProfit.toLocaleString()} cr`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function clearLeaderboard() {
            if (!confirm('Clear all leaderboard data? This cannot be undone.')) return;
            try {
                const response = await fetch(`${API_BASE}/api/leaderboard/clear`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    updateStatus('‚úì Leaderboard data cleared', 'success');
                    document.getElementById('leaderboardContent').style.display = 'none';
                }
            } catch (error) {
                updateStatus(`‚úó Error: ${error.message}`, 'error');
            }
        }

        // Load on page load
        loadLeaderboard();
    </script>
</body>
</html>
